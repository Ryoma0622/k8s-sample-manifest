# For Release
helm upgrade --install ingress-nginx ingress-nginx --repo https://kubernetes.github.io/ingress-nginx --namespace ingress-nginx --create-namespace
helm upgrade --install sample-app-blue sample-app --set image.tag=1.0.0 --set ingress.className=nginx --create-namespace -n sample-app
kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8880:80

curl -v 'http://sample-app-blue.example.com:8880/api/sample'

# For RC

helm upgrade --install ingress-nginx-internal ingress-nginx --repo https://kubernetes.github.io/ingress-nginx --namespace ingress-nginx-internal --create-namespace -f sample-app/internal-nginx-values.yaml
helm upgrade --install sample-app-green sample-app --set image.tag=2.0.0 --set ingress.className=nginx-internal --create-namespace -n sample-app
kubectl port-forward --namespace=ingress-nginx-internal service/ingress-nginx-internal-controller 8888:80

curl -v 'http://sample-app-green.example.com:8888/api/sample'


# Change Services

helm upgrade --install sample-app-blue sample-app -n sample-app --set image.tag=1.0.0 --set ingress.className=nginx --set service.name=sample-app-green
helm upgrade --install sample-app-green sample-app -n sample-app --set image.tag=2.0.0 --set ingress.className=nginx-internal --set service.name=sample-app-blue

helm upgrade --install sample-app-blue sample-app -n sample-app --set image.tag=1.0.0 --set ingress.className=nginx
helm upgrade --install sample-app-green sample-app -n sample-app --set image.tag=2.0.0 --set ingress.className=nginx-internal


# ArgoCD

helm repo add argo https://argoproj.github.io/argo-helm

helm install argocd argo/argo-cd -n argocd --create-namespace

argocd repo add https://github.com/Ryoma0622/sample-rest-api.git

argocd app create sample-app-blue \
  --repo https://github.com/Ryoma0622/sample-rest-api.git \
  --path sample-app \
  --helm-set image.tag=1.0.0 \
  --helm-set ingress.className=nginx \
  --dest-namespace sample-app \
  --dest-server https://kubernetes.default.svc \
  --sync-policy automated \
  --upsert

argocd app create sample-app-green \
  --repo https://github.com/Ryoma0622/sample-rest-api.git \
  --path sample-app \
  --helm-set image.tag=2.0.0 \
  --helm-set ingress.className=nginx-internal \
  --dest-namespace sample-app \
  --dest-server https://kubernetes.default.svc \
  --sync-policy automated \
  --upsert